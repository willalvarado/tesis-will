<div class="historial-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>ğŸ“Š Historial de Sub-tareas</h1>
      <p>Sub-tareas completadas y canceladas</p>
    </div>
    <div class="header-buttons">
      <button class="btn-nav" routerLink="/vendedor/mis-proyectos">
        ğŸ“‚ Mis Proyectos
      </button>
      <button class="btn-nav" routerLink="/vendedor/bienvenida">
        ğŸ  Dashboard
      </button>
      <button class="btn-refresh" (click)="cargarHistorial()" [disabled]="cargando">
        ğŸ”„ {{ cargando ? 'Actualizando...' : 'Actualizar' }}
      </button>
    </div>
  </div>

  <!-- EstadÃ­sticas -->
  <div class="estadisticas-grid">
    <div class="estadistica-card ganado">
      <div class="estadistica-icon">ğŸ’°</div>
      <div class="estadistica-info">
        <span class="estadistica-label">Total Ganado</span>
        <span class="estadistica-valor">${{ totalGanado.toFixed(2) }}</span>
      </div>
    </div>

    <div class="estadistica-card completados">
      <div class="estadistica-icon">âœ…</div>
      <div class="estadistica-info">
        <span class="estadistica-label">Sub-tareas Completadas</span>
        <span class="estadistica-valor">{{ subtareasCompletadas }}</span>
      </div>
    </div>

    <div class="estadistica-card horas">
      <div class="estadistica-icon">â±ï¸</div>
      <div class="estadistica-info">
        <span class="estadistica-label">Horas Trabajadas</span>
        <span class="estadistica-valor">{{ horasTotales }}h</span>
      </div>
    </div>

    <div class="estadistica-card pendientes">
      <div class="estadistica-icon">â³</div>
      <div class="estadistica-info">
        <span class="estadistica-label">Pagos Pendientes</span>
        <span class="estadistica-valor">${{ pagosPendientes.toFixed(2) }}</span>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filtros-container">
    <div class="filtros-titulo">
      <h3>ğŸ” Filtros</h3>
      <button class="btn-limpiar" (click)="limpiarFiltros()">
        Limpiar filtros
      </button>
    </div>

    <div class="filtros-grid">
      <div class="filtro-item">
        <label>Estado de Sub-tarea</label>
        <select [(ngModel)]="filtroEstado" (change)="aplicarFiltros()" class="filtro-select">
          <option value="todos">Todos</option>
          <option value="COMPLETADO">Completado</option>
          <option value="CANCELADO">Cancelado</option>
        </select>
      </div>

      <div class="filtro-item">
        <label>Estado de Pago</label>
        <select [(ngModel)]="filtroPago" (change)="aplicarFiltros()" class="filtro-select">
          <option value="todos">Todos</option>
          <option value="pagado">Pagado</option>
          <option value="pendiente">Pendiente</option>
        </select>
      </div>

      <div class="filtro-item">
        <label>Proyecto</label>
        <input 
          type="text" 
          [(ngModel)]="filtroProyecto" 
          (input)="aplicarFiltros()"
          placeholder="Buscar por proyecto..."
          class="filtro-input"
        >
      </div>

      <div class="filtro-item">
        <label>Fecha de FinalizaciÃ³n</label>
        <input 
          type="date" 
          [(ngModel)]="filtroFecha" 
          (change)="aplicarFiltros()"
          class="filtro-input"
        >
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="cargando">
    <div class="loader"></div>
    <p>Cargando historial...</p>
  </div>

  <!-- Lista de Sub-tareas -->
  <div class="proyectos-lista" *ngIf="!cargando">
    <div class="lista-header">
      <h3>Sub-tareas del Historial ({{ subtareasFiltradas.length }})</h3>
    </div>

    <div class="proyecto-item" *ngFor="let subtarea of subtareasFiltradas">
      <div class="proyecto-main">
        <div class="proyecto-icon">
          <span *ngIf="subtarea.estado === 'COMPLETADO'">âœ…</span>
          <span *ngIf="subtarea.estado === 'CANCELADO'">âŒ</span>
        </div>

        <div class="proyecto-info">
          <div class="subtarea-codigo">{{ subtarea.codigo }}</div>
          <h4>{{ subtarea.titulo }}</h4>
          <p class="proyecto-descripcion">{{ subtarea.descripcion }}</p>
          
          <div class="proyecto-detalles">
            <span class="detalle-item">
              <strong>ğŸ“ Proyecto:</strong> {{ subtarea.proyecto_titulo }}
            </span>
            <span class="detalle-item">
              <strong>ğŸ‘¤ Cliente:</strong> {{ subtarea.cliente_nombre }}
            </span>
            <span class="detalle-item">
              <strong>â±ï¸ Horas:</strong> {{ subtarea.estimacion_horas }}h
            </span>
            <span class="detalle-item">
              <strong>ğŸ”´ Prioridad:</strong> 
              <span [style.color]="obtenerColorPrioridad(subtarea.prioridad)">
                {{ subtarea.prioridad }}
              </span>
            </span>
          </div>

          <div class="proyecto-detalles">
            <span class="detalle-item">
              <strong>ğŸ“… Asignada:</strong> {{ formatearFecha(subtarea.fecha_asignacion) }}
            </span>
            <span class="detalle-item" *ngIf="subtarea.fecha_inicio">
              <strong>ğŸš€ Iniciada:</strong> {{ formatearFecha(subtarea.fecha_inicio) }}
            </span>
            <span class="detalle-item" *ngIf="subtarea.fecha_completado">
              <strong>âœ… Completada:</strong> {{ formatearFecha(subtarea.fecha_completado) }}
            </span>
          </div>
        </div>

        <div class="proyecto-estado">
          <span class="badge-estado" [style.background-color]="obtenerColorEstado(subtarea.estado)">
            {{ obtenerEtiquetaEstado(subtarea.estado) }}
          </span>
        </div>
      </div>

      <div class="proyecto-footer">
        <div class="proyecto-pago">
          <div class="pago-item">
            <span class="pago-label">ğŸ’° Presupuesto:</span>
            <span class="pago-valor">\${{ subtarea.presupuesto.toFixed(2) }}</span>
          </div>
          <div class="pago-item">
            <span class="pago-label">âœ… Pagado:</span>
            <span class="pago-valor pagado">\${{ subtarea.pagado.toFixed(2) }}</span>
          </div>
          <div class="pago-item">
            <span class="pago-label">â³ Pendiente:</span>
            <span class="pago-valor" 
                  [class.pendiente]="subtarea.presupuesto - subtarea.pagado > 0" 
                  [class.completo]="subtarea.presupuesto - subtarea.pagado === 0">
              \${{ (subtarea.presupuesto - subtarea.pagado).toFixed(2) }}
            </span>
          </div>
        </div>

        <div class="proyecto-acciones">
          <button class="btn-ver-chat" [routerLink]="['/vendedor/subtarea', subtarea.id]">
            ğŸ’¬ Ver Chat
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="subtareasFiltradas.length === 0">
      <div class="empty-icon">ğŸ“‹</div>
      <h3>No hay sub-tareas en el historial</h3>
      <p *ngIf="filtroEstado !== 'todos' || filtroPago !== 'todos' || filtroProyecto || filtroFecha">
        Intenta ajustar los filtros para ver mÃ¡s resultados
      </p>
      <p *ngIf="filtroEstado === 'todos' && filtroPago === 'todos' && !filtroProyecto && !filtroFecha">
        Las sub-tareas completadas o canceladas aparecerÃ¡n aquÃ­
      </p>
      <button class="btn-primary" (click)="limpiarFiltros()" 
              *ngIf="filtroEstado !== 'todos' || filtroPago !== 'todos' || filtroProyecto || filtroFecha">
        Limpiar Filtros
      </button>
    </div>
  </div>
</div>