<div class="chat-subtarea-container">
  <!-- Header -->
  <div class="page-header">
    <button class="btn-volver" (click)="volver()">
      â† Volver a Requerimientos
    </button>
    <div class="header-info" *ngIf="subtarea">
      <h2>{{ subtarea.subtarea?.codigo }} - {{ subtarea.subtarea?.titulo }}</h2>
      <span class="estado-badge" [style.background-color]="getEstadoColor(subtarea.subtarea?.estado)">
        {{ getEstadoIcon(subtarea.subtarea?.estado) }} {{ subtarea.subtarea?.estado }}
      </span>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando sub-tarea...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !cargando" class="error-state">
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="cargarSubtarea()">Reintentar</button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!cargando && !error && subtarea" class="content-layout">
    
    <!-- Sidebar izquierdo - Info de la sub-tarea -->
    <aside class="info-sidebar">
      <div class="info-card">
        <h3>ğŸ“‹ InformaciÃ³n</h3>
        
        <div class="info-section">
          <div class="info-item">
            <span class="label">Proyecto:</span>
            <span class="value">{{ subtarea.proyecto?.titulo }}</span>
          </div>
          
          <div class="info-item">
            <span class="label">CÃ³digo:</span>
            <span class="value code">{{ subtarea.subtarea?.codigo }}</span>
          </div>
          
          <div class="info-item">
            <span class="label">Prioridad:</span>
            <span class="value priority" [style.color]="getPrioridadColor(subtarea.subtarea?.prioridad)">
              {{ subtarea.subtarea?.prioridad }}
            </span>
          </div>
          
          <div class="info-item">
            <span class="label">EstimaciÃ³n:</span>
            <span class="value">{{ subtarea.subtarea?.estimacion_horas }}h</span>
          </div>
          
          <div class="info-item">
            <span class="label">Especialidad:</span>
            <span class="value">{{ subtarea.subtarea?.especialidad }}</span>
          </div>
        </div>

        <div class="info-section">
          <h4>ğŸ’° Presupuesto</h4>
          <div class="budget-info">
            <div class="budget-item">
              <span class="budget-label">Total:</span>
              <span class="budget-value">${{ subtarea.subtarea?.presupuesto }}</span>
            </div>
            <div class="budget-item">
              <span class="budget-label">Pagado:</span>
              <span class="budget-value paid">${{ subtarea.subtarea?.pagado }}</span>
            </div>
            <div class="budget-item">
              <span class="budget-label">Pendiente:</span>
              <span class="budget-value pending">${{ subtarea.subtarea?.presupuesto - subtarea.subtarea?.pagado }}</span>
            </div>
          </div>
        </div>

        <div class="info-section" *ngIf="subtarea.vendedor">
          <h4>ğŸ‘¤ Vendedor Asignado</h4>
          <div class="vendedor-card">
            <div class="vendedor-avatar">
              {{ subtarea.vendedor.nombre.charAt(0) }}
            </div>
            <div class="vendedor-info">
              <span class="vendedor-nombre">{{ subtarea.vendedor.nombre }}</span>
              <span class="vendedor-email">{{ subtarea.vendedor.correo }}</span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h4>ğŸ“… Fechas</h4>
          <div class="fechas-list">
            <div class="fecha-item" *ngIf="subtarea.subtarea?.fecha_asignacion">
              <span class="fecha-icon">ğŸ“Œ</span>
              <div class="fecha-text">
                <span class="fecha-label">Asignada:</span>
                <span class="fecha-value">{{ formatearFecha(subtarea.subtarea?.fecha_asignacion) }}</span>
              </div>
            </div>
            <div class="fecha-item" *ngIf="subtarea.subtarea?.fecha_inicio">
              <span class="fecha-icon">ğŸš€</span>
              <div class="fecha-text">
                <span class="fecha-label">Iniciada:</span>
                <span class="fecha-value">{{ formatearFecha(subtarea.subtarea?.fecha_inicio) }}</span>
              </div>
            </div>
            <div class="fecha-item" *ngIf="subtarea.subtarea?.fecha_completado">
              <span class="fecha-icon">âœ…</span>
              <div class="fecha-text">
                <span class="fecha-label">Completada:</span>
                <span class="fecha-value">{{ formatearFecha(subtarea.subtarea?.fecha_completado) }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h4>ğŸ“ DescripciÃ³n</h4>
          <p class="descripcion-text">{{ subtarea.subtarea?.descripcion }}</p>
        </div>

        <!-- ğŸ”¥ NUEVO: ARCHIVOS (CLIENTE) -->
        <div class="info-section archivos-section">
          <div class="archivos-header">
            <h4>ğŸ“ Archivos ({{ archivos.length }})</h4>
            <label class="btn-subir-archivo">
              <input 
                type="file" 
                (change)="onFileSelected($event)" 
                style="display: none"
                [disabled]="subiendoArchivo"
              >
              {{ subiendoArchivo ? 'â³' : 'ğŸ“¤' }} Subir
            </label>
          </div>

          <div class="archivos-list">
            <div class="archivo-item" *ngFor="let archivo of archivos">
              <div class="archivo-info">
                <div class="archivo-nombre">
                  ğŸ“„ {{ archivo.nombre_original }}
                </div>
                <div class="archivo-meta">
                  <span class="archivo-tamano">{{ formatearTamano(archivo.tamano) }}</span>
                  <span class="archivo-por">
                    {{ archivo.subido_por_tipo === 'cliente' ? 'ğŸ‘¤ TÃº' : 'ğŸ‘¥ Vendedor' }}
                  </span>
                </div>
              </div>
              <div class="archivo-acciones">
                <button class="btn-descargar" (click)="descargarArchivo(archivo)">
                  ğŸ“¥
                </button>
                <!-- âŒ CLIENTE NO PUEDE ELIMINAR -->
              </div>
            </div>

            <div class="archivos-empty" *ngIf="archivos.length === 0">
              <p>No hay archivos aÃºn</p>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Chat principal -->
    <main class="chat-main">
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-title">
            <h3>ğŸ’¬ Chat con {{ subtarea.vendedor?.nombre || 'Vendedor' }}</h3>
            <p>Conversa sobre esta sub-tarea</p>
          </div>
        </div>

        <div class="chat-messages">
          <div class="message" 
               *ngFor="let mensaje of mensajes" 
               [class.sent]="mensaje.remitente === 'cliente'" 
               [class.received]="mensaje.remitente === 'vendedor'">
            <div class="message-content">
              <p>{{ mensaje.contenido }}</p>
              <div class="message-info">
                <span class="message-time">{{ formatearHora(mensaje.fecha) }}</span>
                <span class="message-status" *ngIf="mensaje.remitente === 'cliente'">
                  {{ mensaje.leido ? 'âœ“âœ“' : 'âœ“' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div class="empty-chat" *ngIf="mensajes.length === 0">
            <div class="empty-icon">ğŸ’¬</div>
            <p>No hay mensajes aÃºn</p>
            <span>Inicia la conversaciÃ³n con tu vendedor</span>
          </div>
        </div>

        <div class="chat-input">
          <div class="input-wrapper">
            <input 
              type="text" 
              [(ngModel)]="nuevoMensaje"
              (keyup.enter)="enviarMensaje()" 
              placeholder="Escribe tu mensaje..." 
              class="message-input"
            >
            <button 
              class="btn-send" 
              (click)="enviarMensaje()">
              {{ enviandoMensaje ? 'â³' : 'ğŸ“¤' }}
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>