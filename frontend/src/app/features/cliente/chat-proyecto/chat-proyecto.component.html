<div class="chat-page">
  <!-- Header con info del proyecto -->
  <div class="chat-header">
    <button class="btn-back" (click)="volver()">
      ← Volver a Mis Proyectos
    </button>
    
    <div class="proyecto-info" *ngIf="proyecto">
      <div class="proyecto-avatar">👨‍💻</div>
      <div class="proyecto-detalles">
        <h2>{{ proyecto.titulo }}</h2>
        <p>Chat con {{ proyecto.vendedor?.nombre || 'Vendedor' }}</p>
        <span class="estado-badge" [style.background-color]="obtenerColorEstado(proyecto.estado)">
          {{ proyecto.estado }}
        </span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" *ngIf="cargando">
    <div class="loader"></div>
    <p>Cargando chat...</p>
  </div>

  <!-- Contenido principal: Chat + Archivos -->
  <div class="chat-content" *ngIf="!cargando">
    
    <!-- Columna izquierda: MENSAJES -->
    <div class="mensajes-columna">
      <div class="mensajes-container">
        <div class="mensaje-wrapper" *ngFor="let mensaje of mensajes" 
             [class.enviado]="mensaje.remitente === 'cliente'"
             [class.recibido]="mensaje.remitente === 'vendedor'">
          <div class="mensaje-bubble">
            <p class="mensaje-texto">{{ mensaje.contenido }}</p>
            <div class="mensaje-footer">
              <span class="mensaje-hora">{{ formatearHora(mensaje.fecha) }}</span>
              <span class="mensaje-estado" *ngIf="mensaje.remitente === 'cliente'">
                {{ mensaje.leido ? '✓✓' : '✓' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay mensajes -->
        <div class="sin-mensajes" *ngIf="mensajes.length === 0">
          <div class="sin-mensajes-icon">💬</div>
          <p>No hay mensajes aún</p>
          <span>Envía el primer mensaje para iniciar la conversación</span>
        </div>
      </div>
    </div>

    <!-- Columna derecha: ARCHIVOS -->
    <div class="archivos-columna">
      <div class="archivos-header">
        <h3>📎 Archivos del Proyecto</h3>
        <span class="archivos-count">{{ archivos.length }}</span>
      </div>

      <div class="archivos-lista">
        <div class="archivo-item" *ngFor="let archivo of archivos">
          <div class="archivo-info">
            <span class="archivo-icon">{{ obtenerIconoArchivo(archivo.nombre_original) }}</span>
            <div class="archivo-detalles">
              <span class="archivo-nombre">{{ archivo.nombre_original }}</span>
              <span class="archivo-meta">
                {{ formatearTamanio(archivo.tamanio) }} • 
                {{ formatearFechaArchivo(archivo.created_at) }}
              </span>
              <span class="archivo-subido">
                Subido por {{ archivo.subido_por_tipo === 'cliente' ? 'ti' : 'vendedor' }}
              </span>
            </div>
          </div>
          <div class="archivo-acciones">
            <button class="btn-descargar" (click)="descargarArchivo(archivo.id)" title="Descargar">
              📥
            </button>
            <!-- Cliente NO puede eliminar archivos del vendedor -->
            <button 
              *ngIf="archivo.subido_por_tipo === 'cliente'" 
              class="btn-eliminar" 
              (click)="eliminarArchivo(archivo.id)" 
              title="Eliminar"
            >
              🗑️
            </button>
          </div>
        </div>

        <!-- Sin archivos -->
        <div class="sin-archivos" *ngIf="archivos.length === 0">
          <div class="sin-archivos-icon">📂</div>
          <p>No hay archivos</p>
          <span>Sube el primer archivo para compartir</span>
        </div>
      </div>

      <!-- Botón subir archivo -->
      <div class="subir-archivo-area">
        <input 
          type="file" 
          id="fileInput" 
          multiple 
          (change)="onFileSelected($event)" 
          style="display: none"
        >
        <button 
          class="btn-subir-archivo" 
          (click)="abrirSelectorArchivos()"
          [disabled]="subiendoArchivo"
        >
          <span *ngIf="!subiendoArchivo">📤 Subir Archivo</span>
          <span *ngIf="subiendoArchivo">⏳ Subiendo...</span>
        </button>
      </div>
    </div>

  </div>

  <!-- Input para escribir (abajo de todo) -->
  <div class="chat-input-area">
    <div class="input-container">
      <input 
        type="text" 
        [(ngModel)]="nuevoMensaje"
        (keydown.enter)="$event.preventDefault(); enviarMensaje()"
        placeholder="Escribe tu mensaje..."
        [disabled]="enviandoMensaje"
        class="chat-input"
        autocomplete="off"
      >
      <button 
        class="btn-enviar" 
        (click)="enviarMensaje()"
        [disabled]="enviandoMensaje || !nuevoMensaje.trim()"
      >
        <span *ngIf="!enviandoMensaje">📤 Enviar</span>
        <span *ngIf="enviandoMensaje">⏳ Enviando...</span>
      </button>
    </div>
  </div>
</div>